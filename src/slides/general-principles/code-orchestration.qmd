---
title: "Good Simulation Code IV: Orchestration"
subtitle: "SUBTITLE"
author: Vladislav Morozov  
format:
  revealjs:
    include-in-header: 
      text: |
        <meta name="description" content="How to write good Monte Carlo simulation code in data science:   (lecture note slides)"/> 
    width: 1150
    slide-number: true
    sc-sb-title: true
    incremental: true   
    logo: ../../themes/favicon.ico
    footer: "Code Design IV: Orchestration"
    footer-logo-link: "https://vladislav-morozov.github.io/simulations-course/"
    theme: ../../themes/slides_theme.scss
    toc: TRUE
    toc-depth: 2
    toc-title: Contents
    transition: convex
    transition-speed: fast
slide-level: 4
title-slide-attributes:
    data-background-color: "#3c165cff"
    data-footer: " "
filters:
  - reveal-header 
embed-resources: true
include-in-header: ../../themes/mathjax.html 
highlight-style: tango
open-graph:
    description: "How to write good Monte Carlo simulation code in data science:  (lecture note slides)" 
---






## Introduction {background="#00100F"}
 
  

### Lecture Info {background="#43464B"}

#### Learning Outcomes

This lecture is about 

<br>

By the end, you should be able to

 
- A

#### References

::: {.nonincremental}

 
Programming:
 
- Chapter 5 in @Ramalho2022FluentPythonClear about data classes
- 
:::

 
```{python} 
import numpy as np

import matplotlib.pyplot as plt 

plt.rcParams["font.family"] = "sans-serif"
plt.rcParams["font.sans-serif"] = ["Arial"]

BG_COLOR = "whitesmoke"
THEME_COLOR = "#3c165c"
```
 

### Reminder: Previous Simulation Setting {background="#43464B"}


#### Reminder: Study Bias of Penalized SSR Estimators


<div class="left-color">

Talking about <span class="highlight">bias</span> of different <span class="highlight">penalized SSR-based estimators</span>  in simple linear model:

$$ \small
Y_{t} = \beta_0 + \beta_1 X + U_t, \quad t=1, \dots, T
$$ 

</div>

. . . 

Estimators for $\beta_1$ minimize <span class="highlight">penalized SSR</span> with form
$$ \small
(\hat{\beta}_0, \hat{\beta}_1) = \argmin \sum_{t=1}^T (Y_t - b_0 - b_1 X_t)^2 + \lambda \Pcal(b_0, b_1)
$$
$\Pcal(\cdot)$ — penalty (0 for OLS, $L^1$ for Lasso, $L^2$ for ridge)

#### Reminder: File Structure

::: {.nonincremental}

- Already implemented some DGPs, estimators, and a simulation runner
- Figured out a basic file structure

:::

```
project/
├── dgps/
│   ├── __init__.py
│   ├── static.py       # StaticNormalDGP
│   └── dynamic.py      # DynamicNormalDGP
├── estimators/
│   ├── __init__.py
│   ├── ols-like.py     # SimpleOLS, SimpleRidge, LassoWrapper
├── main.py             # Main script that we call from the CLI
├── protocols.py        # DGPProtocol, EstimatorProtocol
└── runner.py           # SimulationRunner
```


## Orchestrating Many Simulations {background="#00100F"}
 
### Problem Statement {background="#43464B"}


#### Reminder: `main.py`

Our script only does one scenario so far:
```{.python filename="main.py"} 
from dgps.dynamic import DynamicNormalDGP
from estimators.ols_like import LassoWrapper
from runner import SimulationRunner

if __name__ == "__main__":
    # Today: just one scenario
    dgp = DynamicNormalDGP(beta0=0.0, beta1=0.95)
    estimator = LassoWrapper(reg_param=0.04)
    n_obs = 50

    # Run simulation for specified scenario
    runner = SimulationRunner(dgp, estimator)
    runner.simulate(n_sim=1000, n_obs=n_obs, first_seed=1)

    # Print results
    print(
        f"Bias for {dgp.__class__.__name__} + {estimator.__class__.__name__}: "
    )
    runner.summarize_bias()
```

::: {.footer}


:::

#### Issue: How To Run Many Scenarios?
 
Key challenge: 

<div class="rounded-box">

How do we run many scenarios automatically?

</div>


A problem of <span class="highlight">orchestration</span>: coordinating multiple tasks

- Automatically 
- As single workflow done in the correct order

Goal: being able to focus on results

#### Why Not Harcode?

One way: just add all scenarios (DGPs, estimators, sample sizes) manually in `main.py`, create `SimulationRunner` for each one

<div class="left-color">

Not a very good approach

</div>

- Brittle: have to edit `main.py` for every change
- Prone to errors 
- Repeats code (e.g. `SimulationRunner` creation)
- Breaks separation of concerns: job of the main script is not to say which scenarios you want today

#### Questions to Answer for Orchestration

<div class="left-color">

- How do we actually express what a scenario is?
- How do we execute all these scenarios?


</div>

<br>

- For now: just  executing simulations and printing results to the console as before
- Later today: dealing with outputs better

### Data Classes {background="#43464B"}

#### How To Encode Scenarios?

#### Creating a Collection of Scenarios

- Can create manually
- Can make automatically (e.g. as a Cartesian product)

### Putting Things Together {background="#43464B"}

#### 

can of course give it a method to add scenarios 

#### Other Tools

Our approach 

`snakemake`


## Simulation Outputs {background="#00100F"}
 
 

#### So Far

So far prints to the console

Usually not what we want

#### Common Approach

Quite typical — export whole raw simulation results

####

Ours are not large, so export 

  
## Recap and Conclusions {background="#00100F"}
 
#### Recap

<br>

In this lecture we 

- Discussed  


#### Further Improvements

Can keep adding things to code:

- Logging and progress tracking
- Improve robustness of code by adding error handling
- Parallelize to take advantage
- Custom output handler classes 

#### Block Recap


#### References {.allowframebreaks visibility="uncounted"}

::: {#refs}
:::
